# サーバのセキュリティ

* サーバーセキュリティの基本
    * セキュリティが不完全のままサーバーを運用
        * サーバー停止や情報漏えいの被害を受ける
        * 知らないうちに加害者になることもある
        
## サーバーのセキュリティとは

### サーバーにはどんな危険があるのか

* 攻撃手法
    * 不正侵入
        * サーバーに登録されているユーザーのパスワードを不正に入手
            * 対策: パスワード管理を徹底して弱いパスワードを使わせないようにする
            * 対策: パスワードを使ってログイン可能なユーザーをないようにする
            * 対策: パスワードを使ってログイン可能なユーザーを制限する
        * ソフトウェアの欠陥(脆弱性)を利用して強引にサーバー上で動いているプログラムの権限を奪う
            * 対策: 脆弱性が発見されたらすかさずシステムのアップデートを行う
    * DoS攻撃
        * Denial of Service
        * 大量のデータをネットワーク経由で送りつけ、サーバーの正常なサービスを妨害する
        * DoS攻撃を大規模化したものがDDoS攻撃
        * 攻撃に使われるのは、コントロールを乗っ取られたパソコンやサーバー
            * 数千〜数万代のコンピューターから一斉にターゲットに向けて接続
        * 対策: 一定時間に大量の接続が試みられたら接続を遮断する設定をする

![Dos攻撃](./image/dos.png)

## サーバーのセキュリティを高める

* アップデート
* 不要なものの選別
* 原則禁止

### アップデート

* アップデート版が提供されたら直ちに適用する
    * ソフトウェアには日々、不具合が発見される
    * 不具合を悪用した攻撃も日々新たなものが登場する
    * セキュリティに緒結する不具合が発見された場合は、アップデート版が提供される
* yu-cronをインストールしておくと、アップデートが定期的に適用される
* 実際のサーバーでは不用意なアップデートで、Webアプリケーションなどが動作しなくなることがある
    * 本番環境でアップデートする前にテスト環境で試して、慎重に行う

```bash
yum -y update #システムをアップデートする
```

```bash
#自動アップデートにする場合
yum -y install yum-cron #yam-cronをインストールする
```

### 不要なものの選別

* ソフトウェアは少なければ少ないほど良い
    * いずれ使うかもしれないソフトは不要
        * アンインストールする
        * yumコマンドに-yオプションを指定ない
            * 誤って必要なパッケージまで削除してしまわないかを確認するため
    * サーバーを構成する数万のソフトウェアのどれかに脆弱性が潜んでいる可能性は十分にある
* すぐに必要のないものは自動的に起動しないようにする

```bash
#不要なパッケージをアンインストール
yum remove パッケージ
#vsftpdパッケージをアンインストールする例
yum remove vsftpd
```

#### すぐに必要のないものは自動的に起動しないようにする

* `enabled`: 自動的に起動するサービス
* `disabled: 自動的に起動しないサービス

```bash
#自動的に起動するかどうかを確認
systemctl list-unit-files -t service
```

```bash
#例:Sambaの自動起動を停止する
systemctl disable smb.service
systemctl disable nmb.service
```

### 原則禁止

* 原則的に通行させない
* ただし許可証を持っているものだけが通行できる
* 最小限のユーザーだけにログインを許可
* 接続元を制限する(原則的にログインできない)
* rootユーザーはログイン禁止がベスト
    * rootは攻撃者はパスワードを当てるだけでシステムの全権限を一気に奪える
    * IDとPWの両方を当てなければならない一般ユーザーよりもちょろい
* システム管理者用の一般ユーザーアカウントを作成
    * その一般ユーザーからsuコマンドを使ってrootユーザーになる
        * 誰がいつrootユーザーになったのか、という記録もログに残せる
* SSHサーバーの待ち受けポート番号を変更する
    * 効果絶大
　    * SSHサーバーは通常、22番ポートで接続を待ち受けする
    * 攻撃者は手当たり次第に22番ポートを開いているサーバーに攻撃を仕掛ける
    * ポートを変更しておくと攻撃者はスルーしてくれる可能性が高くなる
        * SSHサーバーが稼働していないと思う

```bash
#設定ファイル/etc/ssh/sshd_configを編集する
vim /etc/ssh/sshd_config
```

```bash
FILE=/etc/ssh/sshd_config

#書き換え箇所
OLD_PERMIT_ROOT_LOGIN='#PermitRootLogin yes'
NEW_PERMIT_ROOT_LOGIN='PermitRootLogin no'

#例:10022番ポートで待ち受ける
OLD_PORT='#Port 22'
NEW_PORT='Port 10022'

#置き換えのコマンドをまとめる
PERMIT_ROOT_LOGIN="s/${OLD_PERMIT_ROOT_LOGIN}/${NEW_PERMIT_ROOT_LOGIN}/g"
PORT="s/${OLD_PORT}/${NEW_PORT}/g"

sed -i -e "${SERVER_ADMIN}" ${FILE}
sed -i -e "${SERVER_NAME}" ${FILE}

rm ${FILE}-e
```

```bash
systemctl reload sshd.service #SSHサーバーに設定を再度読み込み(リロード)
```

```bash
ssh -p 10022 centos7.example.com #10022番ポートを指定してsshコマンドを実行する
```
