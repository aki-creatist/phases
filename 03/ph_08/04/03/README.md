### 3-1 webアプリケーションにおける認証の役割

* Webアプリケーションでは、ログイン機能において認証が必要です。
* ユーザーIDとパスワードなどの組み合わせで、アクセスしてきたユーザーが本当に本人かどうかを確認する
* 認証の対象としては「個人」以外にも「端末」や「アプリケーション」がある
* 端末の認証は、利用が許可された端末であるかどうかを確認すること
    * 例えば、管理者用サイトへの接続を制限する為に、社内ネットワークからの接続や、特定のIPアドレスを持つPCに限定する場合などに利用
    * アプリケーションの認証は、他のWebアプリケーションやWebサイトと連携する際に、利用が許可されたものであるかどうかを確認すること

#### 個人を認証する

* 本人しか知り得ない情報を確認する(パスワード)
* 本人の身体の一部を使う(バイオメトリクス)
* 本人のみに付与されたデバイスで確認する

#### 端末を認証する

* 端末が許可されている正規のものかを確認する
* クライアント照明書を使う
* シリアル番号などの機器固有情報を確認する

#### アプリケーションを認証する

* アプリケーションが正規のものかを確認する
* 外部アプリケーションに対してユーザー情報へのアクセス等を許可する
* OAuthを使う

#### 原則は本人しか知り得ない情報で確認する

* パスワード以外では指紋認証や虹彩認証、静脈認証などの本人の身体の一部を使う方法(バイオメトリクス)がある

### 3-2 IDやパスワードを狙う攻撃

* 「そう当たり攻撃(ブルート・フォース・アタック」「辞書攻撃」「逆総当たり攻撃(リバース・ブルート・フォース・アタック」がある

#### 総当たり攻撃

| ユーザID | パスワードの組み合わせ |
|:----|:----|
| tanaka | ABCDEFG<br>ABCDEFI<br>ABCDEFJ<br>ABCDEFK<br>ABCDEFL |

#### 辞書攻撃

| ユーザID | パスワードの組み合わせ |
|:----|:----|
| tanaka | 123455<br>password<br>qwerty<br>superman |

#### 逆総当たり攻撃

| ユーザID | パスワードの組み合わせ |
|:----|:----|
| tanaka<br>suzuki<br>kimura | password |

* 総当たり攻撃はユーザーIDが分かっている場合(メールアドレスや社員番号をユーザーIDとして使っている場合)、英数字と記号など、そのサイトで利用できるパスワードの組み合わせを順番に試していく方法
* 辞書攻撃は、「パスワードとしてよく使われれる文字列」をあらかじめ用意しておき、ユーザーのパスワードを推測する攻撃

#### 連続して認証に失敗したらアカウントを停止

* パスワードの総当たり攻撃や、辞書攻撃への対策としては、アカウントロックアウトが有効
    * アカウントロックアウトとは、同一ユーザーの認証において一定時間内に連続して認証に失敗した場合に、そのユーザーの認証を停止すること

### 3-3 サーバーでの安全なパスワード保存方法

* サーバーでパスワードを保存するときは、ハッシュ関数を使い、パスワード文字列を「ハッシュ値」にする

#### パスワードに"隠し味"を加えておく

* パスワードのハッシュ値を求める際はユーザーの設定したパスワードに「ソルト（Salt)」を加える
    * 十分な長さのソルトを加えることで、ハッシュ値からパスワードを推測することが困難になる
    * また、「レインボーテーブル」と呼ばれるパスワード辞書を使った攻撃の対策としても有効
        * あらかじめ用意された「ハッシュ化されたパスワードの辞書」

```text
[salt (ユーザと後に異なる)] + [password] × n回繰り返す
```

#### ソルトを使わないと同一の平文は同じハッシュ値になる

| ユーザID | パスワード(平文) | Salt | ハッシュ値(SHA-256) |
| Tanaka | password | なし | abcdefghijklms |
| Tanaka | password | なし | abcdefghijklms |

#### ソルトを使わないと同一の平文は異なるハッシュ値になる

| ユーザID | パスワード(平文) | Salt | ハッシュ値(SHA-256) |
| Tanaka | password | なし | fajp389fjewes |
| Tanaka | password | なし | fawjp9348fjwg |

### 3-4パスワード機能の実装上の注意点

#### ユーザに強いパスワードを設定してもらうには

* 一定以上の文字数が必要(短いと総当たり攻撃に弱い
* 英字(大文字・小文字)、数字、記号を組みわせる(記号を加えると辞書攻撃に強くなる)
* 推測が容易なパスワード(ユーザIDと同一、123456やaaaaaaaなど英数字の繰り返し、辞書に載っているような単語)は設定させない

#### パスワード変更機能を設計する際の注意点

* パスワード変更機能を実装する際は、以下の3点に注意が必要
    * 第一に、パスワード変更は原則して本人が行うようにします。ユーザーがパスワードを忘れた場合も、管理者がパスワードを変更できないようにする
    * 第二に、パスワードの世代管理を行い、パスワード変更時に複数世代前と同じパスワードを設定させない
    * 第三に、パスワードを含む個人情報やセキュリティ設定が変更されたら、登録されているメールアドレスに変更があったことを通知する

#### パスワードリカバリー機能を設計する際の注意点

* このほかにパスワードを変更する際のプロセス管理者を含む他人が介在しないようにする為に、パスワードを忘れたときの対処機能を盛り込む
    * この機能を「パスワードリカバリー」と呼ぶ
        * 1. 登録しているメールアドレスを入力
            * アドレス以外の情報(電話番号など)も入力してもらうとPWリカバリを大量に送りつける嫌がらせを回避できる
        * 2. トークンを生成し、ユーザIDに紐づけてサーバで保存する
            * いっって位時間経過後に無効にするため、発行日時も合わせて記録する
        * 3. トークンを付与したパスワードリカバリー用のURLをメールに添付して送付
        * 4. メールに記載されたURLにアクセス(トークンを送付)
        * 5. トークンが一致することを確認することで、正規のユーザからのパスワード変更リクエストであることを確認

#### 新規ユーザーの大量登録を防ぐ

* スクリプトやツールによる新規ユーザーの大量登録や、自動化されたログインを防ぐ方法として、「CAPTCHA」がある
    * CAPTCHAとはCompletely Automated Public Turning test to tell Computers and Humans Apart
    * 「コンピュータと人間を区別する完全に自動化された公開チューリングテスト」
    * スクリプトやツールなどでは読めない文字列をユーザーに入力させることで、相手が人間であることを確認する方法
    
#### 外部認証を利用する

* 他サイトの認証機能を利用する仕組みを「外部認証」という
    * 外部認証としては「OpneID」が有名です
* OpenIDはさまざまなWebサイトで共通のID情報を利用できるようにした認証方式の一つ
* ユーザーは、サービスごとの新たにアカウントとパスワードを登録する必要がなくなります。(図3-11)。

### 3-5リスト型アカウントハッキング

* パスワードに関する攻撃として、ここ数年話題になっている
* 他のWebサイトから不正に入手したユーザーIDとパスワードの組合せを使って、攻撃対象となるWebサイトにログインをこころみる攻撃のこと

### 手口

* 脆弱性のあるWebサイトにID/PWを登録させる
    * PWをハッシュ化して保存 例: name/qwerasdf
* 攻撃者はSQLインジェクションなどの脆弱性を悪用してIDとパスワードの組み合わせを入手
* ID/PWの組み合わせでログインできるか順番に試す
    * これによりWebサイトで有効なID/PWを入手する

### 3-6クロスサイト・リクエスト・フォージェリ

* 認証の不備を突いた代表的な攻撃
    * CSRF
* リクエストを偽造して、ユーザーが気づかないうちに、不正な操作をあたかも正常動作のように行せる攻撃のこと
* フォージェリ（forgery)は偽造という意味
* HTTPはステートレスなプロトコルなので状態遷移を管理できません。そのため、リクエストが外部のWebアプリケーションの画面から送信されたものかどうかを区別できない
* セッションIDが正規のものであれば、正規ユーザーから送信されたリクエストとして処理をしてしまいます。

![image/security_3-13.png](03/image/security_3-13.png)

* ユーザーが、CSRFの脆弱性があるWebサイトにログイン
* ユーザーが(1)のサイトにログインしたままに状態で、別のサイトに移動する
    * このサイトは攻撃者が用意した「罠」のサイト。「罠」のサイトには、CSRFの脆弱性があるWebサイトに対して不正なリクエストを送信する攻撃コードが仕込まれている
* 「罠のサイトに仕掛けられた攻撃コードが(1)のWebサイトに対して送信される
    * このとき、Webブラウザーは(1）のWebサイトのセッションIDを送信する
* (1)のWebサイトでは、偽造されたリクエストであるにも関わらず、セッションIDでユーザ識別をしている為、正規のリクエストとして処理を実行

#### 特定の口座への送金も可能に

```text
CSRF脆弱性の危険度は、Webシステムが持つ機能(処理)の重要度に依存する
例えば、CSRFの脆弱性を悪用すると次のようなことができてしまう
```

* ユーザーのパスワードや登録情報の変更、場合によってはユーザーを勝手に退会させる
* 管理者権限の奪取
* 特定の商品を購入させる、特定の口座に送金させる
* 「お問い合わせフォーム」を利用して、ユーザーが知らないうちにメールを送信させる
* 家庭用ルータ等のWeb管理画面でDNS(Domain Name System)情報を改ざんする

#### 思わずクリックしてしまう手口で誘導

* 攻撃コードにJSを加えることで、ユーザーがWebサイトを閲覧しただけでCSRF攻撃を発動させることも可能
* Webアプリケーションが、コンテンツを要求するGETリクエストの処理を受け付けるように設計・実装されている場合、画像を表示するimgタグなどを使った攻撃が可能です。
    * この場合、CSRFの攻撃コードを送信するように、imgタグのsrc属性を改ざんしたWebページを読み込むことで攻撃が成立

#### トークンの利用や再認証で対策

```text
CSRFへの対策には、「トークンを利用する」方法と「重要な処理では再認証を行う」方法がある
```

![image/security_3-14.png](03/image/security_3-14.png)

* トークンは、リクエストが偽造されていないかどうかを確認するために使う
    * トークンはWebアプリケーションでは「一時的に利用可能な、疑似乱数」という意味がある
* CSRF対策を施したい画面ではトークンを発行し、画面には表示されないhiddenパラメータに含めておく
* 同時にセッション変数でもトークンを保持
* リクエストを受けとった際には、hiddenパラメータとして送信されてきたトークンと、セッションに格納していたトークンが合致するかどうかを検証
    * 合致しない場合は、リクエストが偽造されたと判断

# 第3章

## 3-7　端末を認証する

```text
端末の認証は、Webアプリケーションを利用しようとしている端末が、利用が許可されている正規の端末かどうかを確認すること
```

端末を認証する方法としては、

* 「クライアント証明書を利用する」
    * 認証局を用意し、事前にクライアント証明書を配布して管理する必要がある
* 「端末のシリアル番号の様な機器固有情報を利用する」
* 「携帯電話の契約者IDを利用する」

## 3-8　アプリケーションを認証する

* アプリケーションの認証は、Webアプリケーション間で連携する際に、接続してきたWebアプリケーションがユーザーによって許可されているかどうかを確認すること
    * アプリケーションの認証について、一つ事例を紹介
    * 2010年にアパレルメーカーのユニクロが、Twitterと連携した「UNIQLO LUCKY LINE」というキャンペーンサイトを立ち上げた
    * この企画は、キャンペーンサイトでTwitterのアカウントとパスワードを入力することで、サイト上の仮想の行列に並ぶというもの
        * 行列に並んだユーザーには抽選でプレゼントが当たります。
    * 行列に並ぶと、登録したユーザーのTwitterのタイムラインに「つぶやき」が投稿される
    * キャンペーンサイトがユーザーの代わりにつぶやきを投稿するために、アカウントとパスワードの入力が必要だった
    * このキャンペーンは話題を呼び、およそ14万人のユーザーが登録したといわれている
    * ソーシャルネットワークサービスの口コミによる拡散効果を利用したWebキャンペーンとしては、成功の部類に入る
    * しかし、Webアプリケーションのセキュリティの観点からは問題がある
* 問題となるのは、このキャンペーンに登録する際に、Twitterのアカウントとパスワードをキャンペーンサイトに入力させること
* Twitterのパスワードを、Twitter以外の第三者であるサイトに入力してしまうのは、パスワードの原則である、「（パスワードは）本人しか知り得ない」を破ることになるため

### OAuthを利用してほかのWebアプリと連携

* 他のWebアプリケーションと連携する際は、OAuth（オーオース）と呼ぶ
* OAuth自体は本来、認証（本人確認）というよりも、Webアプリケーション間でAPIなどを通じて安全にアクセス権を付与するための仕組み

OAuthを利用するセキュリティ上の利点は以下の通りです。

* 他のアプリケーションにパスワードなどの認証情報を保存する必要がない
* ほかのアプリケーションに提供できる範囲を指定できる
* ほかのアプリケーションに与えた認可を取り消せる
* OAuthの処理_Facebookを利用する例
    * OAuth ClientはOAuthサーバに対してアクセス権を要求
    * ユーザはOAuthクライアントに対するアクセス権の付与を確認
    * OAuth Serverはユーザが許可した場合、トークンを付与
    * ユーザはサービスを利用し、Facebookに投稿
    * OAuth Clientはトークンを用いてリクエストを送信
    * OAuth Serverはトークンが有効なものであることを確認しリクエストを処理
* OAuthによる認証・アプリケーション連携のAPIを提供しているサービスを「OAuth Server」と呼ぶ
* 図中ではFaceBookがOAuth Server
* OAuth Serverと連携したいアプリケーションを「OAuth Client」と呼ぶ

##### OAuthのフロー

* OAuth ClientからOAuth　Serverに対してアクセス権を求める
* OAuth Crientにアクセス権を与えてよいかどうかを、OAuth Serverがユーザーに確認する
* ユーザーが許可すると、OAuth ServerがOAuth Clientにアクセストークンを付与
* OAuth ClientはOAuth Serverから付与されたアクセストークン（パスワードではない）を保持し、OAuth Serverに対してリクエストを送付
* 以降の処理では、アクセストークンが有効かどうかをOAuth Serverが確認した上で、OAuth Clientからのリクエストを処理する
* ユーザーがOAuth Clientに与えたアクセス権を取り消したい場合には、OAuth Serverで無効化可能
* Facebookの場合、[設定] - [アプリ設定]でアクセス権を与えているアプリと、どのようなアクセス権を与えているかを確認し、取り消せる

## まとめ

### Webアプリケーションにおける認証の役割

* 認証の役割は「本人確認」。アクセスしてきた人が本人かどうかを確認する
* 本人確認の手段として「本人しか知りえない情報（パスワード）」を使う
* パスワード以外の認証要素を組み合わせた認証方法を「多要素認証」という

### IDやパスワードを狙う攻撃

* 「総当たり攻撃」は、パスワードの組み合わせを順番に試していく
* 「辞書攻撃」は、パスワードとしてよく使われる文字列を辞書として使う
* 「逆総当たり攻撃」は、パスワードを固定して、ユーザーIDを総当たりの対象にする

### パスワード機能の実装上の注意点

* パスワードを連続して間違えた場合には、一定時間そのユーザーの認証を停止する
* 「アカウントロック」を設ける。
* パスワードの総当たり攻撃による被害を軽減できる。
* パスワードを間違った場合に表示するメッセージは画一的なものにする。
* 認証のエラーメッセージからユーザーの存在が確認できないようにする
* パスワードやメールアドレスなど、認証にかかわる情報が変更された場合には、変更をメールでユーザーに通知する。
* 第三者による不正アクセスを早期に検知できる可能性がある。

### リスト型アカウントハッキング

* 他のWebサイトから入手したユーザーIDとパスワードの組み合わせを使ってログインを試みる攻撃を「リスト型アカウントハッキング」という
* 一定の割合でパスワードを使いまわしているユーザーがいることから、総当たり攻撃や辞書攻撃よりも効率よく認証を突破できる。Webサイト運営者側も、攻撃に気づくのが難しい
* 「パスワードの使いまわし」に関する注意喚起をするほか、「攻撃を予防する対策」、「攻撃による被害の拡大を防ぐ対策」に分けて必要な対策を施す。多要素認証の導入や、ユーザーへの気付きを与える機能を盛り込むとよい

### クロスサイト・リクエスト・フォージェリ(CSRF)

* CRSFは、リクエストを偽装して、ユーザーが気づかないうちに、不正な操作をあたかも正常動作のように実施する攻撃
* CSRFによる被害を防ぐには、「トークンを利用する」方法と「重要な処理では再認証する」方法がある

### 端末を認証する

* 「利用が許可されている端末かどうか」を確認するのが端末の認証
* 端末を認証する方法としては、
    * 「クライアント証明書を利用する方法」
    * 「端末のシリアル番号の様な機器固有情報を利用する方法」
    * 「携帯電話の契約者IDを利用する方法」etc
* シリアル番号のような機器固有の情報は偽造が可能な場合があるので、機器固有情報だけでの認証は避けるようにする。
* 個人を認証する仕組みと合わせて活用する

### アプリケーションを認証する

* アプリケーションの認証とは、<font color="red">アプリケーション間で連携する際に、接続してきたアプリケーションがユーザーによって許可されているかどうかを確認する</font>こと
* 自社WebサイトでほかのWebサービスの認証情報の入力を求めてはならない
* アプリケーションを認証する鵜場合には、OAuthを利用する