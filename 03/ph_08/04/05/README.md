# 攻撃手法

* [ローカルプロキシーを使った入力データの改変](01)
* [クロスサイトスクリプティング](02)
* [SQLインジェクション](03)
* [OSコマンドインジェクション](04)
* [ヘッダーインジェクション](05)
    * HTTPヘッダーインジェクション
    * メールヘッダーインジェクション

## 入力パラメータ

* GETメソッドで受け取るクエリストリング
* POSTメソッドで受け取るパラメータ(テキストやテキストクエリなどの入力項目、ラジオボタンやセレクトボックスなどの選択項目及びhidden項目)
* Cookieから取り出したパラメータ
* ヘッダー情報(User-AgentやRefererなどの情報)

## 入力チェックだけでは対策にならない

* Webアプリケーションでは、ユーザーがWebブラウザー上でテキストなどを入力した後、Webサーバーに送信する前にクライアント側でJSによる入力チェックを行う
    * クライアント側での入力チェックの目的は、Webサーバーに送り出す前にユーザーに入力間違いなどを通知できる点
    * ただし、JSによる入力チェックは無効化が可能
* ローカルプロキシーを使うことで、JSによる入力チェックをパスした後に、webサーバーに送信するパラメータの改ざんも可能
    * このため、クライアント側で行う入力チェックだけに依存してはいけない
* Webサーバー側で入力チェックをする際には、すべての入力値をチェックし、入力された各項目がWebアプリケーションの機能要件を満たしているかどうかを確認する
    * 入力された文字列の長さや形式(メールアドレスや電話番号)、利用可能な文字(機能要件で禁止されている文字)かどうかetc
    * また、ラジオボタンやセレクトボックスのような選択式の入力項目の場合には、値が規定の範囲内かどうかをチェックする

## 入力チェックをパスした後は、プログラムがデータを処理する

* 入力された検索条件をもとにして以下のことを行う
    * DBに発行するSQLコマンドを組み立てたり
    * 入力されたディレクトリにあるファイル一覧を取得するためにOSコマンドを組み立てたり
    * Webブラウザーに処理結果を返すためにHTMLを組み立てたり
* SQLコマンドやOSコマンド、HTMLには、特殊な意味を持つ「特殊文字」がある
    * SQLコマンド
        * `'`: 値の区切り
        * `;`: (SQLコマンドの終わり
        * `--`: コメント
    * OSコマンド
        * `'`: 値の区切り
        * `;`: コマンドを続けて実行
    * HTML
        * `<`: HTMLタグの始まり
        * `>`: HTMLタグの終わり
        
こうした「値やコマンドの区切り文字(デリミタ)」などの特殊文字を混入させ、その後に不正なコマンドを挿入するのが、インジェクション系の攻撃の基本

### インジェクション系の攻撃を防ぐには

* 出力先のシステムの特殊文字に応じたエスケープ処理が必要
    * エスケープ処理とは、言語や実行環境によって特別な意味を持つ文字や記号を、別の文字や記号に変換して、特別な意味を打ち消す処理のこと
* エスケープ処理を施す場合の注意点は、「出力する直前に、文字列を組み立てた最終形態で行う」こと
    * ここの入力チェックを通過した場合でも組み合わせた場合に特殊な意味を持つ文字列になる場合があるから
    
SQLコマンドやOSコマンド、HTMlを出力する際のエスケープ処理が不適切だと、インジェクションやクロスサイトスクリプティングを防げない

## まとめ

### すべての入力データは信用できない

* Webアプリケーションが受け取るデータはすべて「信用できない」と考えるべき
* 「入力チェック」はあくまでシステムの機能要件に基づいて設計・実装するもの
* 入力チェックと出力時の適切なエスケープ処理を組み合わせる

### クロスサイトスクリプティング

* クロスサイトスクリプティング(XSS)とは、ユーザーのWebブラウザー上で動作する不正なスクリプト(JS)を混入する攻撃手法または脆弱性のこと
* WebアプリケーションがHTMLを出6するときに、HTMLの特殊文字を適切に処理せずに出力することが原因
* 対策の基本は、「HTMLの側手文字を別の文字や記号に変換するエスケープ処理(HTMLエンコーディング)」と、「タグの属性値を必ず引用符(「"」ダブルクォート)でくくること」
* HTMLエンコーディングやJSのエスケープは、出力する箇所の文脈に応じて実装する必要があり、間違いが生じやすいので注意する

### SQLインジェクション

* SQLインジェクションとは、Webアプリケーションの設計・開発者が意図しないSQL文が実行されてしまう攻撃手法または脆弱性のこと
* DBに対する攻撃なので、「機密データの漏洩」「データの改ざん」など、非常に重大な被害をもたらす可能性がある
* WebアプリケーションがSQL文を動的に組み立てる際に発生する
* 根本的な対策は、SQL文の呼び出しにプレースホルダ方式を使うこと

### その他のインジェクション系の脆弱性

* OSコマンドインジェクションとは、OSコマンドを呼び出している箇所で、任意のOSコマンドを実行されてしまう攻撃手法または脆弱性のこと。OSコマンドを起動する実装を避けられないか検討する
* ヘッダーインジェクションとは、HTTPヘッダーやメールヘッダーで、改行オードに続けて任意のヘッダーを出力してしまう攻撃手法または脆弱性のこと。HTTPヘッダー出力専用の関数を利用するようにする。最低限の対策として、ヘッダー出力時に改行コードを取り除くかエラーにする
* ディレクトリートラバーサルは、ファイル名に含まれるディレクトリーの扱いに不備があるために、想定外のファイルが処理の対象とされてしまう攻撃手法または脆弱性のこと。外部パラメータとしてファイル名を指定する使用を避ける

### インジェクション攻撃には実装フェーズで対処

* インジェクション系の攻撃手法・脆弱性の対策は、主に実装フェーズが中心になる
* このため、要件定義や基本設計を進めることで、実装工程になってからの手戻りを防げるようになる

