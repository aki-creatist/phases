# HTTPセッションの設計

* セッション情報のライフサイクルを設計
    * HTTPセッションにどのような情報を格納し
    * その情報がどこで作成されて
    * どこで破棄されるか

## HTTPセッションとクラスタリング

* セッション情報は、Webアプリによってメモリ中に保持・管理されている
* Webアプリケーションサーバーをクラスタ構成にした場合
    * セッション情報を保持・管理しているメモリ空間がサーバーごとに分かれてしまう
* ロードバランサのラウンドロビンなどでリクエストが不規則にサーバーに割り振られると最初にアクセスされたサーバーと違うサーバーにはセッション情報がないことになる
    * `ラウンドロビン`: ロードバランサが複数のサーバーに処理を順次割り当てること

### 解決方法

* [サーバー間のセッション情報の共有](01)
* [ロードバランサによるセッションスティッキー](02)

## Sessionとは

* HTTPというステートレスなプロトコルにおいて、状態を保持するための仕組み
    * システムが現在の状態を表すデータなどを保持しない
    * 入力の内容によってのみ出力が決定される方式
* HTTPセッションの仕組みを使わなければ、HTTPリクエストが来るたびに全く別のリクエストとして処理される
    * これではログインなどの認証を実現しない
    * ECサイトで買い物かごを実現することも不可能
* HTTPリクエスト間に関連を持たせるには、リクエストに同じIDを付与する
    * `リクエストに同じID`: セッションID
    * HTTPセッションは、Webブラウザからのリクエストごとに、このセッションIDをリクエスト情報に付与することで実現する
    * セッションIDを付与する方法は大きく２つ
        * Cookieを使う方法
        * URL Rewriting

## Cookie

* HTTPに関連した技術
    * Webブラウザに小さな情報を書き出すことが可能
    * 書き出したサーバーのドメインの情報を持ち、同じドメインに対してしか送信しない
    * このWebブラウザの挙動によって他のサーバーが書き出したCookieを参照することは不可
    * サーバーがこのCookieにセッションIDを書き込むことで、WebブラウザはHTTPリクエストのたびにサーバーが書き出したCookieだけを送出してくれる
    * `サーバーはCookieの中からセッションIDを取得`
        * メモリに保持しているセッション情報をひも付ける

## URL Rewriting

* セッションIDをURLパラメータに付与
    * それ以外の考え方は、Cookieを使った場合と同じ
    * Cookieに対応していない環境でURL Rewritingを使用
    * セッションIDが第三者に漏洩すると、セッションハイジャックといったセキュリティ問題になる
    * URL Rewritingでは、URLパラメータにセッションIDがついている
        * 比較的漏洩しやすいので注意が必要